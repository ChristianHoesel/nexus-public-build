name: Build Nexus OSS

on:
  workflow_dispatch:
    inputs:
      nexus_version:
        description: 'Nexus version/branch to build (e.g., release-3.87.1-01)'
        required: true
        default: 'release-3.87.1-01'
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:
    branches:
      - main
  # schedule:
    # Weekly build every Monday at 2 AM UTC
    # - cron: '0 2 * * 1'

env:
  JAVA_VERSION: '21'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout Nexus Public
        uses: actions/checkout@v4
        with:
          repository: sonatype/nexus-public
          ref: ${{ github.event.inputs.nexus_version || 'release-3.87.1-01' }}
          path: nexus-public
          fetch-depth: 1

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack for Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.9.1 --activate
          echo "Corepack enabled, Yarn version:"
          yarn --version

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: |
            nexus-public/.yarn/cache
            nexus-public/.yarn/unplugged
            nexus-public/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('nexus-public/**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies with Yarn 4
        working-directory: nexus-public
        run: |
          # Remove all Yarn configuration files
          rm -f .yarnrc.yml .yarnrc
          find . -name ".yarnrc.yml" -o -name ".yarnrc" | xargs rm -f

          # Reset Yarn cache and global config
          rm -rf ~/.yarn ~/.yarnrc.yml ~/.yarnrc

          # Create new .yarnrc.yml for Yarn 4
          cat > .yarnrc.yml << 'EOF'
          nodeLinker: node-modules
          EOF

          # Install dependencies with Yarn 4 (allow lockfile creation)
          yarn install --no-immutable

      - name: Build Frontend Workspaces with Yarn 4
        working-directory: nexus-public
        run: |
          # Build all frontend workspaces with Yarn 4
          yarn workspaces foreach --all --topological-dev run build-all

      - name: Switch to Yarn 1.x for Maven
        run: |
          # Disable Corepack
          corepack disable || true
          # Install Yarn 1.22 globally for Maven
          npm install -g yarn@1.22.22
          echo "Switched to Yarn version:"
          yarn --version

      - name: Build Nexus
        working-directory: nexus-public
        run: |
          # Maven build with "public" profile
          # Frontend was already built with Yarn 4, Maven skips frontend steps
          ./mvnw install -Ppublic -DskipTests -Dmaven.javadoc.skip=true -ntp -Dskip.installyarn -Dskip.yarn
        env:
          MAVEN_OPTS: "-Xmx4g -XX:+UseG1GC"

      - name: Package Distribution
        working-directory: nexus-public
        run: |
          # Extract project version from POM
          PROJECT_VERSION=$(grep '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | sed -n '2p')
          echo "Packaging version: $PROJECT_VERSION"

          cd assemblies/nexus-repository-core/target

          STAGING_DIR="nexus-${PROJECT_VERSION}"
          rm -rf "$STAGING_DIR"
          mkdir "$STAGING_DIR"

          # copy the assembly contents into the named top-level folder
          cp -a assembly/. "$STAGING_DIR"/

          # Ensure correct Unix permissions before creating tarball
          # - directories and files readable, directories executable
          chmod -R u+rwX,go+rX "$STAGING_DIR"
          # - scripts in bin/ must be executable
          if [ -d "$STAGING_DIR/bin" ]; then
            chmod +x "$STAGING_DIR/bin"/*
          fi

          # create tarball and zip with a top-level folder
          tar -czf "${STAGING_DIR}-unix.tar.gz" "$STAGING_DIR"
          zip -qr "nexus-${PROJECT_VERSION}.zip" "$STAGING_DIR"

          # cleanup
          rm -rf "$STAGING_DIR"

      - name: Run tests (optional)
        if: github.event_name == 'workflow_dispatch'
        working-directory: nexus-public
        run: |
          ./mvnw verify -Ppublic
        continue-on-error: true

      - name: Find built artifacts
        id: artifacts
        run: |
          echo "Finding Nexus artifacts..."
          find nexus-public -name "nexus-*.tar.gz" -o -name "nexus-*.zip" | tee artifacts.txt

      - name: Upload Nexus artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: |
            nexus-public/**/target/nexus-*.tar.gz
            nexus-public/**/target/nexus-*.zip
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            nexus-public/**/target/nexus-*.tar.gz
            nexus-public/**/target/nexus-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: ./artifacts

      - name: Extract Nexus version from artifact
        id: version
        run: |
          # Find the tar.gz file and extract version from filename
          TARBALL=$(find ./artifacts -name "nexus-*.tar.gz" | head -n 1)
          if [ -z "$TARBALL" ]; then
            echo "No Nexus tarball found!"
            exit 1
          fi

          # Extract version from filename (e.g., nexus-3.86.0-08-unix.tar.gz -> 3.86.0-08)
          VERSION=$(basename "$TARBALL" | sed 's/nexus-\(.*\)-unix\.tar\.gz/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected Nexus version: ${VERSION}"

          # Copy tarball to root for Docker build
          cp "$TARBALL" ./nexus-${VERSION}.tar.gz

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.ref_type == 'tag'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image (for tag builds)
        if: github.ref_type == 'tag'
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXUS_VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Docker image (for non-tag builds)
        if: github.ref_type != 'tag'
        id: build-load
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXUS_VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image tag for testing
        id: set-tag
        run: |
          # Get the first tag from metadata output
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n 1)
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${IMAGE_TAG}"

      - name: Export Docker image for testing (for non-tag builds)
        if: github.ref_type != 'tag'
        run: |
          # Save the image with the determined tag
          docker save "${{ steps.set-tag.outputs.tag }}" -o /tmp/nexus-image.tar
          echo "Saved image: ${{ steps.set-tag.outputs.tag }}"
          
      - name: Upload Docker image artifact (for non-tag builds)
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.run_id }}
          path: /tmp/nexus-image.tar
          retention-days: 1

      - name: Image digest
        run: echo "Docker image built with tags ${{ steps.meta.outputs.tags }}"

  test-docker:
    needs: build-docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Download Docker image artifact (for non-tag builds)
        if: github.ref_type != 'tag'
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ github.run_id }}
          path: /tmp

      - name: Load Docker image (for non-tag builds)
        if: github.ref_type != 'tag'
        run: |
          docker load -i /tmp/nexus-image.tar
          # Use the tag from build-docker job output
          echo "IMAGE_NAME=${{ needs.build-docker.outputs.image-tag }}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry (for tag builds)
        if: github.ref_type == 'tag'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image (for tag builds)
        if: github.ref_type == 'tag'
        run: |
          # Pull the image that was just pushed using the actual tag
          docker pull ${{ needs.build-docker.outputs.image-tag }}
          echo "IMAGE_NAME=${{ needs.build-docker.outputs.image-tag }}" >> $GITHUB_ENV

      - name: Run Docker image tests
        run: |
          chmod +x test-docker-image.sh
          ./test-docker-image.sh

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Container logs ==="
          # Find and show logs for any nexus-test-* containers
          if docker ps -a --filter "name=nexus-test-" --format "{{.Names}}" | grep -q .; then
            docker ps -a --filter "name=nexus-test-" --format "{{.Names}}" | while read container; do
              echo "Logs for $container:"
              docker logs "$container" 2>&1 || echo "Could not retrieve logs"
            done
          else
            echo "No test containers found"
          fi
