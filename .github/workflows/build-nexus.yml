name: Build Nexus OSS

on:
  workflow_dispatch:
    inputs:
      nexus_version:
        description: 'Nexus version/branch to build (e.g., release-3.87.1-01)'
        required: true
        default: 'release-3.87.1-01'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # schedule:
    # Weekly build every Monday at 2 AM UTC
    # - cron: '0 2 * * 1'

env:
  JAVA_VERSION: '21'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout Nexus Public
        uses: actions/checkout@v4
        with:
          repository: sonatype/nexus-public
          ref: ${{ github.event.inputs.nexus_version || 'release-3.87.1-01' }}
          path: nexus-public
          fetch-depth: 1

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack for Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.9.1 --activate
          echo "Corepack enabled, Yarn version:"
          yarn --version

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: |
            nexus-public/.yarn/cache
            nexus-public/.yarn/unplugged
            nexus-public/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('nexus-public/**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies with Yarn 4
        working-directory: nexus-public
        run: |
          # Remove all Yarn configuration files
          rm -f .yarnrc.yml .yarnrc
          find . -name ".yarnrc.yml" -o -name ".yarnrc" | xargs rm -f

          # Reset Yarn cache and global config
          rm -rf ~/.yarn ~/.yarnrc.yml ~/.yarnrc

          # Create new .yarnrc.yml for Yarn 4
          cat > .yarnrc.yml << 'EOF'
          nodeLinker: node-modules
          EOF

          # Install dependencies with Yarn 4 (allow lockfile creation)
          yarn install --no-immutable

      - name: Build Frontend Workspaces with Yarn 4
        working-directory: nexus-public
        run: |
          # Build all frontend workspaces with Yarn 4
          yarn workspaces foreach --all --topological-dev run build-all

      - name: Switch to Yarn 1.x for Maven
        run: |
          # Disable Corepack
          corepack disable || true
          # Install Yarn 1.22 globally for Maven
          npm install -g yarn@1.22.22
          echo "Switched to Yarn version:"
          yarn --version

      - name: Build Nexus
        working-directory: nexus-public
        run: |
          # Maven build with "public" profile
          # Frontend was already built with Yarn 4, Maven skips frontend steps
          ./mvnw install -Ppublic -DskipTests -Dmaven.javadoc.skip=true -ntp -Dskip.installyarn -Dskip.yarn
        env:
          MAVEN_OPTS: "-Xmx4g -XX:+UseG1GC"

      - name: Package Distribution
        working-directory: nexus-public
        run: |
          # Extract project version from POM
          PROJECT_VERSION=$(grep '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | sed -n '2p')
          echo "Packaging version: $PROJECT_VERSION"

          cd assemblies/nexus-repository-core/target

          STAGING_DIR="nexus-${PROJECT_VERSION}"
          rm -rf "$STAGING_DIR"
          mkdir "$STAGING_DIR"

          # copy the assembly contents into the named top-level folder
          cp -a assembly/. "$STAGING_DIR"/

          # Ensure correct Unix permissions before creating tarball
          # - directories and files readable, directories executable
          chmod -R u+rwX,go+rX "$STAGING_DIR"
          # - scripts in bin/ must be executable
          if [ -d "$STAGING_DIR/bin" ]; then
            chmod +x "$STAGING_DIR/bin"/*
          fi

          # create tarball and zip with a top-level folder
          tar -czf "${STAGING_DIR}-unix.tar.gz" "$STAGING_DIR"
          zip -qr "nexus-${PROJECT_VERSION}.zip" "$STAGING_DIR"

          # cleanup
          rm -rf "$STAGING_DIR"

      - name: Run tests (optional)
        if: github.event_name == 'workflow_dispatch'
        working-directory: nexus-public
        run: |
          ./mvnw verify -Ppublic
        continue-on-error: true

      - name: Find built artifacts
        id: artifacts
        run: |
          echo "Finding Nexus artifacts..."
          find nexus-public -name "nexus-*.tar.gz" -o -name "nexus-*.zip" | tee artifacts.txt

      - name: Upload Nexus artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: |
            nexus-public/**/target/nexus-*.tar.gz
            nexus-public/**/target/nexus-*.zip
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            nexus-public/**/target/nexus-*.tar.gz
            nexus-public/**/target/nexus-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-artifacts:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: ./artifacts

      - name: Extract Nexus version from artifact
        id: version
        run: |
          # Find the tar.gz file and extract version from filename
          TARBALL=$(find ./artifacts -name "nexus-*-unix.tar.gz" | head -n 1)
          if [ -z "$TARBALL" ]; then
            echo "No Nexus tarball found!"
            exit 1
          fi

          # Extract version from filename (e.g., nexus-3.86.0-08-unix.tar.gz -> 3.86.0-08)
          VERSION=$(basename "$TARBALL" | sed 's/nexus-\(.*\)-unix\.tar\.gz/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected Nexus version: ${VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Nexus Repository OSS ${{ steps.version.outputs.version }}
          body: |
            Nexus Repository OSS build version ${{ steps.version.outputs.version }}
            
            Built from: ${{ github.event.inputs.nexus_version || 'latest' }}
            
            ## Artifacts
            - `nexus-${{ steps.version.outputs.version }}-unix.tar.gz` - Linux/Unix distribution
            - `nexus-${{ steps.version.outputs.version }}.zip` - Windows distribution
            
            ## Docker Image
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ```
          files: |
            artifacts/**/nexus-*.tar.gz
            artifacts/**/nexus-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  integration-test:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: ./artifacts

      - name: Extract and prepare Nexus
        id: extract
        run: |
          # Find the tar.gz file
          TARBALL=$(find ./artifacts -name "nexus-*-unix.tar.gz" | head -n 1)
          if [ -z "$TARBALL" ]; then
            echo "No Nexus tarball found!"
            exit 1
          fi
          
          echo "Found tarball: $TARBALL"
          
          # Extract the tarball
          tar -xzf "$TARBALL" -C ./
          
          # Find the extracted directory
          NEXUS_DIR=$(find . -maxdepth 1 -type d -name "nexus-*" | head -n 1)
          if [ -z "$NEXUS_DIR" ]; then
            echo "No extracted Nexus directory found!"
            exit 1
          fi
          
          echo "nexus_dir=${NEXUS_DIR}" >> $GITHUB_OUTPUT
          echo "Extracted to: $NEXUS_DIR"
          
          # Verify structure
          ls -la "$NEXUS_DIR/"
          
          # Ensure bin scripts are executable
          chmod +x "$NEXUS_DIR/bin"/*

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Start Nexus
        run: |
          NEXUS_DIR="${{ steps.extract.outputs.nexus_dir }}"
          WORK_DIR="$(pwd)"
          
          # Create proper directory structure (matching official Nexus setup)
          mkdir -p sonatype-work/nexus3
          
          # Set Nexus environment variables
          export NEXUS_DATA="${WORK_DIR}/sonatype-work/nexus3"
          export SONATYPE_WORK="${WORK_DIR}/sonatype-work"
          
          # Create required subdirectories in NEXUS_DATA
          mkdir -p "${NEXUS_DATA}/etc" "${NEXUS_DATA}/log" "${NEXUS_DATA}/tmp"
          
          # Set INSTALL4J_ADD_VM_PARAMS for JVM configuration
          export INSTALL4J_ADD_VM_PARAMS="-Xms1g -Xmx1g -XX:MaxDirectMemorySize=1g -Djava.util.prefs.userRoot=${NEXUS_DATA}/javaprefs"
          
          echo "Starting Nexus in background..."
          echo "NEXUS_DIR: $NEXUS_DIR"
          echo "NEXUS_DATA: $NEXUS_DATA"
          echo "SONATYPE_WORK: $SONATYPE_WORK"
          
          nohup "$NEXUS_DIR/bin/nexus" run > nexus.log 2>&1 &
          NEXUS_PID=$!
          echo "Nexus PID: $NEXUS_PID"
          
          # Save PID for cleanup
          echo $NEXUS_PID > nexus.pid

      - name: Wait for Nexus to start
        run: |
          echo "Waiting for Nexus to be ready on port 8081..."
          
          # Wait up to 5 minutes for Nexus to start
          MAX_WAIT=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # First check if port is open
            if curl -f -s http://localhost:8081/ > /dev/null 2>&1; then
              echo "✅ Nexus is responding on port 8081!"
              # Try to get status endpoint if available
              if curl -f -s http://localhost:8081/service/rest/v1/status > /dev/null 2>&1; then
                echo "✅ Nexus status endpoint is available!"
                curl -s http://localhost:8081/service/rest/v1/status
              fi
              curl -s http://localhost:8081/ | head -20
              exit 0
            fi
            
            echo "Waiting for Nexus to start... ($ELAPSED seconds)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
            
            # Show last few lines of log for debugging
            if [ -f nexus.log ]; then
              echo "Last 10 lines of nexus.log:"
              tail -10 nexus.log
            fi
          done
          
          echo "❌ Nexus did not start within $MAX_WAIT seconds"
          echo "Full log:"
          cat nexus.log
          exit 1

      - name: Cleanup
        if: always()
        run: |
          if [ -f nexus.pid ]; then
            NEXUS_PID=$(cat nexus.pid)
            if kill -0 $NEXUS_PID 2>/dev/null; then
              echo "Stopping Nexus (PID: $NEXUS_PID)..."
              kill $NEXUS_PID || true
              
              # Wait up to 15 seconds for graceful shutdown
              for i in {1..15}; do
                if ! kill -0 $NEXUS_PID 2>/dev/null; then
                  echo "Nexus stopped gracefully"
                  break
                fi
                sleep 1
              done
              
              # Force kill if still running
              if kill -0 $NEXUS_PID 2>/dev/null; then
                echo "Forcing Nexus to stop..."
                kill -9 $NEXUS_PID 2>/dev/null || true
              fi
            fi
          fi
          
          # Show final log for debugging
          if [ -f nexus.log ]; then
            echo "Final Nexus log:"
            cat nexus.log
          fi

  build-docker:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nexus-oss-build-${{ github.event.inputs.nexus_version || 'latest' }}
          path: ./artifacts

      - name: Extract Nexus version from artifact
        id: version
        run: |
          # Find the tar.gz file and extract version from filename
          TARBALL=$(find ./artifacts -name "nexus-*.tar.gz" | head -n 1)
          if [ -z "$TARBALL" ]; then
            echo "No Nexus tarball found!"
            exit 1
          fi

          # Extract version from filename (e.g., nexus-3.86.0-08-unix.tar.gz -> 3.86.0-08)
          VERSION=$(basename "$TARBALL" | sed 's/nexus-\(.*\)-unix\.tar\.gz/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected Nexus version: ${VERSION}"

          # Copy tarball to root for Docker build
          cp "$TARBALL" ./nexus-${VERSION}.tar.gz

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXUS_VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo "Docker image pushed successfully with tags ${{ steps.meta.outputs.tags }}"
